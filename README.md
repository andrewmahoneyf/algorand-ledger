# algorand-ledger
Scripts to sign transaction in Algorand Blockchain using ledger

## What we did
Manage to create addresses and sign some transactions with the algokey tool.
Managed to use the javascript api and to encode/decode keys and msgpacked transactions.
Based on that I built my own javascript scripts to generate transactions, sign and send them to the node.
Managed to build the algorand-ledger app, to install and use it in a ledger nano-s device.
Ported the “cli/sign.py” from the algorand-ledger code to javascript and with that I managed to generate and sign with the ledger a transaction using nodejs.
Managed to generate my own multisignature addresses from a set of public addresses using the kmd command as reference.
Manage to build, sign and send transactions for multisignature addresses. The signature for each address can be done with ledger or with a private key generated with the algokey command.

My ledger public address: 
    KKNXJL6OIIPIAOKHK62UMJAI7LCFXXGTIUZNDQIBDN6LFBNT7VQNIGHACY 

Some of the addresses generated with algokey:
OPH5MFQSAEDCJDSG7ZROACLHFDLQEDW4DFB75BJ5342EPX24APOID6Q2LQ
3YTLLBUEODAAVQSAZ7MTADKKXUWOUJCBLCOFI2UIHA6OEX4E23TO5O4RWI
Requirements
NodeJS
Run ‘npm install’ in the directory where the scripts are located 

## Usage

The first script that you need to run is: 
prepare_transaction.js to amount fee firstblock [pks | pks...]
Where: 
To is the destination address
Amount is the amount in algos
Fee is the fee in algos
First block is used to declare the range in which the transaction is valid, right now we use firstblock + 1000 that is the maximum range possible.
Pks are can be one public address in a regular transaction or multiple public addresses for a multi-signature transaction.
This script generates a json with the information to be signed, I don’t use msgpack (like algokey) because is good to be able to read the information plaintext.
In the case of a multisignature the from field is calculated from the set of public keys and the keys are added to the json because they must be sent to the node (after adding the corresponding signatures).

The json then can be sent to two different scripts:
Sign_with_ledger.js
This script take the json and build the binary buffer that is send to the ledger for signing. After that it adds the resulting signature. In the case of a multi-signature transactions it adds the signature to the corresponding public key.
Sign_with_priv.js
This script takes the path to a file generated by algokey command. It signs the transaction and add the resulting signature. Checking that the from is correct.

Finally the json is sent to the send.js script. This script takes the node token, ip and port. With that it builds the final buffer and send it to the node using the sendRawTransaction rest api.

## Examples

### Multisig
node prepare_transaction.js 3YTLLBUEODAAVQSAZ7MTADKKXUWOUJCBLCOFI2UIHA6OEX4E23TO5O4RWI 1233 100 272001 Z6IMXKHPUNR4YVDTNSYDLE4DGBRRU7VLAY4NOQ2JEEZBTCKJ72KSVX7TE4 OPH5MFQSAEDCJDSG7ZROACLHFDLQEDW4DFB75BJ5342EPX24APOID6Q2LQ J4GGCZW7JA5NKQDX4U5TRX4AR7YPNZRX7VQ44YCUJ3BYEEO72KEKKWVNBM  | node sign_with_ledger.js | node sign_with_priv.js key.priv | node send.js 7fa7c128461e1486619e2b33542da289b85b2eec54d6800abe169c5cc1bdc063 10.10.0.85 8080

The resulting transaction:
http://algoexplorer.com/tx/J2NYPVZBZJZRQWPO7DBKRGBKVH22XDO4MTJWIGL657JYHO35MJHA

### Singlesig
node prepare_transaction.js 3YTLLBUEODAAVQSAZ7MTADKKXUWOUJCBLCOFI2UIHA6OEX4E23TO5O4RWI 1233 100 288206 KKNXJL6OIIPIAOKHK62UMJAI7LCFXXGTIUZNDQIBDN6LFBNT7VQNIGHACY | node sign_with_ledger.js | node send.js 7fa7c128461e1486619e2b33542da289b85b2eec54d6800abe169c5cc1bdc063 10.10.0.85 8080

Resulting transaction:
https://algoexplorer.com/tx/RNX5GWIIBZA277AC5JDUQIBFCPSEOOG7SS4J45IVNGAQ72FEBDYA
